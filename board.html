<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UGS Weekly Movement Board</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #fafafa;
      margin: 0;
    }
    header {
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      padding: 1rem;
      background: #fff;
      border-bottom: 2px solid #aaa;
    }
    h2 {
      text-align: left;
      margin: 1rem 0 0.5rem 0.5rem;
      font-size: 1.2rem;
      text-transform: uppercase;
    }
    .board-wrapper {
      padding: 0 0.5rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      background: #fff;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #333;
      padding: 0.4rem;
      text-align: center;
      font-size: 0.88rem;
      word-wrap: break-word;
    }
    th {
      background: #eee;
      font-weight: bold;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    input[type="text"] {
      width: 95%;
      padding: 0.2rem;
    }
    .status-btn {
      display: inline-block;
      padding: 4px 8px;
      border: 1px solid #666;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
    .in { background: #b6fcb6; }     /* green */
    .out { background: #fcb6b6; }   /* red */
    .rdc, .on { background: #ffd27f; } /* orange */

    button {
      margin: 0.2rem;
      padding: 0.3rem 0.6rem;
    }

    #pinModal {
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
    }
    #pinBox {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    #pinBox input {
      padding: 0.4rem;
      font-size: 1rem;
    }

    #editControls {
      text-align: center;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <header>UGS WEEKLY MOVEMENT BOARD</header>

  <div class="board-wrapper">
    <h2>Main Staff</h2>
    <div id="mainControls" style="display:none;">
      <button onclick="addMainStaff()">+ Add Main Staff</button>
      <button onclick="deleteLast('mainRows')">- Delete Last Main</button>
    </div>
    <table id="mainBoard">
      <thead>
        <tr>
          <th>POSITION</th><th>NAME</th><th>IN</th><th>OUT</th><th>RDC</th><th>ON CALL</th>
          <th>THURS</th><th>FRI</th><th>SAT</th><th>SUN</th><th>MON</th><th>TUES</th><th>WED</th>
        </tr>
      </thead>
      <tbody id="mainRows"></tbody>
    </table>

    <h2>LG CESMs</h2>
    <div id="cesmControls" style="display:none;">
      <button onclick="addCesmStaff()">+ Add CESM Staff</button>
      <button onclick="deleteLast('cesmRows')">- Delete Last CESM</button>
    </div>
    <table id="cesmBoard">
      <thead>
        <tr>
          <th>POSITION</th><th>NAME</th><th>IN</th><th>OUT</th><th>RDC</th><th>ON CALL</th>
          <th>THURS</th><th>FRI</th><th>SAT</th><th>SUN</th><th>MON</th><th>TUES</th><th>WED</th>
        </tr>
      </thead>
      <tbody id="cesmRows"></tbody>
    </table>
  </div>

  <div id="editControls">
    <button id="editBtn" onclick="startEdit()">Edit</button>
    <button id="finishBtn" style="display:none;" onclick="finishEdit()">Finish Editing</button>
  </div>

  <!-- PIN Modal -->
  <div id="pinModal">
    <div id="pinBox">
      <p>Enter Edit PIN</p>
      <input type="password" id="pinInput" placeholder="****">
      <button onclick="checkPin()">Submit</button>
    </div>
  </div>

<script>
  const BIN_ID = "68d62f7ad0ea881f408b72a5";
  const API_KEY = "$2a$10$oIE7le5...";
  const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}/latest`;
  const UPDATE_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
  const PIN = "0563"; 

  let canEdit = false;
  let mainStaff = [];
  let cesmStaff = [];
  let pinPending = false;

  // Data functions
  async function loadData() {
    try {
      const res = await fetch(API_URL, { headers: { "X-Master-Key": API_KEY } });
      const json = await res.json();
      const data = json.record;
      mainStaff = data.mainStaff || [];
      cesmStaff = data.cesmStaff || [];
      renderAll();
    } catch (err) { console.error("Error loading:", err); }
  }

  async function saveData() {
    const data = { mainStaff, cesmStaff };
    try {
      await fetch(UPDATE_URL, {
        method: "PUT",
        headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
        body: JSON.stringify(data)
      });
    } catch (err) { console.error("Error saving:", err); }
  }

  // Rendering
  function renderBoard(data, id){
    const tbody = document.getElementById(id);
    tbody.innerHTML = "";
    data.forEach((s,i)=>{
      let row = document.createElement("tr");
      row.innerHTML = `
        ${textCell(s,i,id,"pos")}
        ${textCell(s,i,id,"name")}
        ${statusCell(s,i,id,"in","in")}
        ${statusCell(s,i,id,"out","out")}
        ${statusCell(s,i,id,"rdc","rdc")}
        ${statusCell(s,i,id,"on","on")}
        ${textCell(s,i,id,"thu")}
        ${textCell(s,i,id,"fri")}
        ${textCell(s,i,id,"sat")}
        ${textCell(s,i,id,"sun")}
        ${textCell(s,i,id,"mon")}
        ${textCell(s,i,id,"tue")}
        ${textCell(s,i,id,"wed")}
      `;
      tbody.appendChild(row);
    });
  }

  function textCell(staff,i,arrId,key){
    let val = staff[key]||"";
    return canEdit 
      ? `<td><input type="text" value="${val}" oninput="update('${arrId}',${i},'${key}',this.value)"></td>`
      : `<td>${val||"&nbsp;"}</td>`;
  }

  function statusCell(staff,i,arrId,key,className){
    let active = staff[key]==="true";
    if(canEdit){
      return `<td><div class="status-btn ${active?className:""}" onclick="toggleStatus('${arrId}',${i},'${key}','${className}',this)">
                ${className.toUpperCase()}
              </div></td>`;
    } else {
      return `<td><div class="status-btn ${active?className:""}">${className.toUpperCase()}</div></td>`;
    }
  }

  window.toggleStatus = function(arrId,i,key,className,el){
    const arr = arrId==="mainRows"?mainStaff:cesmStaff;
    arr[i][key] = arr[i][key]==="true" ? "false" : "true";
    if(arr[i][key]==="true"){ el.classList.add(className);} else{ el.classList.remove(className);}
    saveData();
  };

  window.update=function(arrId,i,key,val){
    const arr = arrId==="mainRows"?mainStaff:cesmStaff;
    arr[i][key]=val;
    saveData();
  };

  function renderAll(){
    renderBoard(mainStaff,"mainRows");
    renderBoard(cesmStaff,"cesmRows");
    document.getElementById("mainControls").style.display=canEdit?"block":"none";
    document.getElementById("cesmControls").style.display=canEdit?"block":"none";
    document.getElementById("editBtn").style.display=canEdit?"none":"inline-block";
    document.getElementById("finishBtn").style.display=canEdit?"inline-block":"none";
  }

  // Add / delete last row
  function blank(){ return {pos:"",name:"",in:"false",out:"false",rdc:"false",on:"false",
    thu:"",fri:"",sat:"",sun:"",mon:"",tue:"",wed:""}; }

  window.addMainStaff=()=>{mainStaff.push(blank());saveData();renderAll();}
  window.addCesmStaff=()=>{cesmStaff.push(blank());saveData();renderAll();}

  window.deleteLast=function(arrId){
    if(arrId==="mainRows" && mainStaff.length){ mainStaff.pop();}
    if(arrId==="cesmRows" && cesmStaff.length){ cesmStaff.pop();}
    saveData();renderAll();
  }

  // Edit workflow
  function startEdit(){ 
    pinPending=true; 
    document.getElementById("pinModal").style.display="flex"; 
  }
  function finishEdit(){
    canEdit=false;
    saveData();
    renderAll();
  }
  function checkPin(){
    if(document.getElementById("pinInput").value===PIN){
      if(pinPending){ 
        canEdit=true; 
        renderAll(); 
      }
      document.getElementById("pinModal").style.display="none";
      pinPending=false;
    }else alert("Wrong PIN");
  }

  loadData(); setInterval(loadData,10000);
</script>
</body>
</html>
